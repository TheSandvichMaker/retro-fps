// Generated by metagen.lua

void shader_set_params__post_draw_parameters_t(rhi_command_list_t *list, uint32_t slot, post_draw_parameters_t *params)
{
	rhi_validate_texture_srv(params->bloom, S("post_draw_parameters_t::bloom"), 0);
	rhi_validate_texture_srv(params->blue_noise, S("post_draw_parameters_t::blue_noise"), 0);
	rhi_validate_texture_srv(params->resolved_color, S("post_draw_parameters_t::resolved_color"), 0);
	rhi_set_parameters(list, slot, params, sizeof(*params));
}

#define DF_SHADER_POST_SOURCE_CODE \
	"// Generated by metagen.lua from post.metashader\n" \
	"\n" \
	"#include \"common.hlsli\"\n" \
	"\n" \
	"// 0: lerp\n" \
	"// 1: screen\n" \
	"#define BLOOM_BLEND 1\n" \
	"\n" \
	"#include \"gen/post.hlsli\"\n" \
	"\n" \
	"ConstantBuffer< post_draw_parameters_t > draw : register(b0);\n" \
	"\n" \
	"float3 apply_tonemap(float3 color)\n" \
	"{\n" \
	"	return 1.0 - exp(-color);\n" \
	"}\n" \
	"\n" \
	"float4 post_ps(fullscreen_triangle_vs_out_t IN) : SV_Target\n" \
	"{\n" \
	"	float2 uv = IN.uv;\n" \
	"	uint2  co = uint2(IN.pos.xy);\n" \
	"\n" \
	"	Texture2D<float3> tex_color      = draw.resolved_color.Get();\n" \
	"	Texture2D<float4> tex_blue_noise = draw.blue_noise    .Get();\n" \
	"\n" \
	"	float3 color      = tex_color     .Load(uint3(co, 0));\n" \
	"	float4 blue_noise = tex_blue_noise.Load(uint3(co % 64, 0));\n" \
	"\n" \
	"	[branch]\n" \
	"	if (draw.bloom_amount > 0.0)\n" \
	"	{\n" \
	"		float3 bloom = draw.bloom.Get().SampleLevel(df::s_linear_clamped, uv, 0);\n" \
	"\n" \
	"#if BLOOM_BLEND == 0\n" \
	"		color = lerp(color, bloom, draw.bloom_amount);\n" \
	"		color = apply_tonemap(color);\n" \
	"#elif BLOOM_BLEND == 1\n" \
	"		color = apply_tonemap(color);\n" \
	"		bloom = apply_tonemap(bloom);\n" \
	"		color = 1.0 - (1.0 - color)*(1.0 - draw.bloom_amount*bloom);\n" \
	"#endif\n" \
	"	}\n" \
	"	else\n" \
	"	{\n" \
	"		color = apply_tonemap(color);\n" \
	"	}\n" \
	"\n" \
	"#if DREAM_DEVELOPMENT\n" \
	"	if (any(isnan(color)))\n" \
	"	{\n" \
	"		static const uint NaN[2*8*8] = {\n" \
	"			0, 0, 0, 0, 0, 0, 0, 0,\n" \
	"			0, 1, 0, 0, 0, 0, 1, 0,\n" \
	"			0, 1, 1, 0, 0, 0, 1, 0,\n" \
	"			0, 1, 0, 1, 0, 0, 1, 0,\n" \
	"			0, 1, 0, 0, 1, 0, 1, 0,\n" \
	"			0, 1, 0, 0, 0, 1, 1, 0,\n" \
	"			0, 1, 0, 0, 0, 0, 1, 0,\n" \
	"			0, 0, 0, 0, 0, 0, 0, 0,\n" \
	"\n" \
	"			0, 0, 0, 0, 0, 0, 0, 0,\n" \
	"			0, 0, 0, 0, 0, 0, 0, 0,\n" \
	"			0, 0, 1, 1, 1, 1, 0, 0,\n" \
	"			0, 1, 0, 0, 0, 1, 0, 0,\n" \
	"			0, 1, 0, 0, 0, 1, 0, 0,\n" \
	"			0, 1, 0, 0, 0, 1, 0, 0,\n" \
	"			0, 0, 1, 1, 1, 0, 1, 0,\n" \
	"			0, 0, 0, 0, 0, 0, 0, 0,\n" \
	"		};\n" \
	"\n" \
	"		uint x = co.x % 8;\n" \
	"		uint y = co.y % 8;\n" \
	"		uint n = (co.x / 8) % 2;\n" \
	"		uint i = n*8*8 + y*8 + x;\n" \
	"		uint xo = 8*(view.frame_index / view.refresh_rate);\n" \
	"		uint xi = (((co.x - xo) / 24) & 1) ^ (((co.x - xo + 16) / 24) & 1);\n" \
	"		uint yi = (co.y / 8) & 1;\n" \
	"		uint blink = xi ^ yi ^ ((xo / 24) & 1);\n" \
	"\n" \
	"		color = NaN[i] ^ blink ? float3(1, 0, 0) : float3(0, 0, 0);\n" \
	"	}\n" \
	"#endif\n" \
	"\n" \
	"	float3 dither = RemapTriPDF(blue_noise.rgb) / 255.0;\n" \
	"	color += dither;\n" \
	"\n" \
	"	return float4(color, 1.0);\n" \
	"}\n" \
	"\n" \
