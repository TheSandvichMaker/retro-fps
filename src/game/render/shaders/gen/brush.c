// Generated by metagen.lua

void shader_set_params__brush_draw_parameters_t(rhi_command_list_t *list, uint32_t slot, brush_draw_parameters_t *params)
{
	rhi_validate_texture_srv(params->albedo, S("brush_draw_parameters_t::albedo"), 0);
	rhi_validate_texture_srv(params->lightmap, S("brush_draw_parameters_t::lightmap"), 0);
	rhi_set_parameters(list, slot, params, sizeof(*params));
}

void shader_set_params__brush_pass_parameters_t(rhi_command_list_t *list, uint32_t slot, brush_pass_parameters_t *params)
{
	rhi_validate_buffer_srv(params->lm_uvs, S("brush_pass_parameters_t::lm_uvs"));
	rhi_validate_buffer_srv(params->positions, S("brush_pass_parameters_t::positions"));
	rhi_validate_texture_srv(params->sun_shadowmap, S("brush_pass_parameters_t::sun_shadowmap"), 0);
	rhi_validate_buffer_srv(params->uvs, S("brush_pass_parameters_t::uvs"));
	rhi_set_parameters(list, slot, params, sizeof(*params));
}

#define DF_SHADER_BRUSH_SOURCE_CODE \
	"// Generated by metagen.lua from brush.metashader\n" \
	"\n" \
	"#include \"common.hlsli\"\n" \
	"\n" \
	"#include \"gen/brush.hlsli\"\n" \
	"\n" \
	"ConstantBuffer< brush_draw_parameters_t > draw : register(b0);ConstantBuffer< brush_pass_parameters_t > pass : register(b1);\n" \
	"\n" \
	"struct VS_OUT\n" \
	"{\n" \
	"	float4 position           : SV_Position;\n" \
	"	float4 shadowmap_position : SHADOWMAP_POSITION;\n" \
	"	float2 uv                 : TEXCOORD;\n" \
	"	float2 lightmap_uv        : LIGHTMAP_TEXCOORD;\n" \
	"};\n" \
	"\n" \
	"VS_OUT brush_vs(uint vertex_index : SV_VertexID)\n" \
	"{\n" \
	"	float3 position    = pass.positions.Get().Load(vertex_index);\n" \
	"	float2 uv          = pass.uvs      .Get().Load(vertex_index);\n" \
	"	float2 lightmap_uv = pass.lm_uvs   .Get().Load(vertex_index);\n" \
	"\n" \
	"	VS_OUT OUT;\n" \
	"	OUT.position           = mul(view.world_to_clip, float4(position, 1));\n" \
	"	OUT.shadowmap_position = mul(view.sun_matrix,    float4(position, 1));\n" \
	"	OUT.uv                 = uv;\n" \
	"	OUT.lightmap_uv        = lightmap_uv;\n" \
	"	return OUT;\n" \
	"}\n" \
	"\n" \
	"float4 brush_ps(VS_OUT IN) : SV_Target\n" \
	"{\n" \
	"	Texture2D<float3> tex_albedo   = draw.albedo  .Get();\n" \
	"	Texture2D<float3> tex_lightmap = draw.lightmap.Get();\n" \
	"	float2            albedo_dim   = draw.albedo_dim;\n" \
	"	float2            lightmap_dim = draw.lightmap_dim;\n" \
	"\n" \
	"	float3 albedo = tex_albedo  .Sample(df::s_aniso_wrap, FatPixel(albedo_dim, IN.uv)).rgb;\n" \
	"	float3 light  = tex_lightmap.Sample(df::s_aniso_clamped, IN.lightmap_uv/*FatPixel(lightmap_dim, IN.lightmap_uv)*/).rgb;\n" \
	"\n" \
	"	const float3 shadow_test_pos   = IN.shadowmap_position.xyz / IN.shadowmap_position.w;\n" \
	"	const float2 shadow_test_uv    = 0.5 + float2(0.5, -0.5)*shadow_test_pos.xy;\n" \
	"	const float  shadow_test_depth = shadow_test_pos.z;\n" \
	"\n" \
	"	const float bias = max(0.025*(1.0 - max(0, dot(draw.normal, view.sun_direction))), 0.010);\n" \
	"	const float biased_depth = shadow_test_depth + bias;\n" \
	"\n" \
	"	float2 shadowmap_dim;\n" \
	"	pass.sun_shadowmap.Get().GetDimensions(shadowmap_dim.x, shadowmap_dim.y);\n" \
	"\n" \
	"	float shadow_factor = SampleShadowPCF3x3(pass.sun_shadowmap.Get(), shadowmap_dim, shadow_test_uv, biased_depth);\n" \
	"\n" \
	"	float n_dot_l = dot(draw.normal, view.sun_direction);\n" \
	"	light += shadow_factor*(view.sun_color*max(0.0f, n_dot_l));\n" \
	"\n" \
	"	float3 result = albedo*light;\n" \
	"\n" \
	"	return float4(result, 1);\n" \
	"}\n" \
	"\n" \
